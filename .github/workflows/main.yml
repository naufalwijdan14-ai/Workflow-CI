name: Titanic MLflow CI Advance

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  mlflow-ci-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install mlflow dagshub pandas scikit-learn joblib mlserver mlserver-mlflow

      - name: Run Training with MLflow
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_URI: https://dagshub.com/naufalwijdan14-ai/Eksperimen_SML_Muhamad-Naufal-Wijdan.mlflow
        run: |
          # Bypass login prompt
          mkdir -p ~/.dagshub
          echo "{\"token\": \"${{ secrets.DAGSHUB_TOKEN }}\"}" > ~/.dagshub/tokens
          
          cd MLProject
          # Menjalankan training (modelling.py akan otomatis kirim log ke DagsHub)
          python modelling.py --n_estimators 100 --max_depth 5

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: naufalwijdan14 
          password: ${{ secrets.NAUFALWIJDAN }}

      - name: Build and Push Docker Image
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_TRACKING_URI: https://dagshub.com/naufalwijdan14-ai/Eksperimen_SML_Muhamad-Naufal-Wijdan.mlflow
        run: |
          # Build Docker menggunakan model yang sudah ter-register 'Titanic_Project'
          mlflow models build-docker \
            -m "models:/Titanic_Project/latest" \
            -n "naufalwijdan14/titanic-model:latest" \
            --enable-mlserver
          
          # Push ke Docker Hub
          docker push naufalwijdan14/titanic-model:latest
